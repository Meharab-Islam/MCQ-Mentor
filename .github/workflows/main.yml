name: Flutter CI/CD

# WorkflowржЯрж┐ ржХржЦржи ржЯрзНрж░рж┐ржЧрж╛рж░ рж╣ржмрзЗ
on:
  pull_request:
    branches:
      - main
      - master
      - develop
  push:
    branches:
      - main
      - master
      - develop

jobs:
  # 1. CI Job: ржХрзЛржб ржЯрзЗрж╕рзНржЯ ржПржмржВ ржЕрзНржпрж╛ржирж╛рж▓рж╛ржЗржЬ ржХрж░рж╛рж░ ржЬржирзНржп (Ubuntu ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ, ржпрж╛ ржжрзНрж░рзБржд ржУ рж╕рж╕рзНрждрж╛)
  test_and_analyze:
    name: ЁЯзк Test & Analyze (CI)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Flutter SDK рж╕рзЗржЯржЖржк
      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Check Code Formatting
        # ржпржжрж┐ ржХрзЛржирзЛ ржлрж░ржорзЗржЯрж┐ржВ ржкрж░рж┐ржмрж░рзНрждржи рж╣рзЯ, рждржмрзЗ ржлрзЗржЗрж▓ ржХрж░ржмрзЗред
        # рж╕рзНржерж╛ржирзАржпрж╝ржнрж╛ржмрзЗ `flutter format .` рж░рж╛ржи ржХрж░рзЗ ржкрж░рж┐ржмрж░рзНрждржи ржХржорж┐ржЯ ржХрж░рж▓рзЗ ржПржЗ ржзрж╛ржк рж╕ржлрж▓ рж╣ржмрзЗред
        run: flutter format --set-exit-if-changed . # <--- dart format ржПрж░ ржкрж░рж┐ржмрж░рзНрждрзЗ flutter format ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рж▓рзЛ

      - name: Analyze Project Source
        # Flutter-ржПрж░ ржЬржирзНржп dart analyze ржиржпрж╝, flutter analyze ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ ржнрж╛рж▓рзЛ
        run: flutter analyze

      - name: Run Flutter Tests
        run: flutter test

  # 2. CD Job: ржЯрзЗрж╕рзНржЯ рж╕ржлрж▓ рж╣рж▓рзЗ ржмрж┐рж▓рзНржб ржПржмржВ рж░рж┐рж▓рж┐ржЬ ржХрж░рж╛рж░ ржЬржирзНржп (iOS-ржПрж░ ржЬржирзНржп macos-latest ржкрзНрж░ржпрж╝рзЛржЬржи)
  build_and_release:
    name: ЁЯЪА Build & Release (CD)
    needs: test_and_analyze # рж╢рзБржзрзБржорж╛рждрзНрж░ ржЖржЧрзЗрж░ ржЬржм рж╕ржлрж▓ рж╣рж▓рзЗржЗ рж░рж╛ржи рж╣ржмрзЗ
    runs-on: macos-latest # iOS ржмрж┐рж▓рзНржбрзЗрж░ ржЬржирзНржп macos рж░рж╛ржирж╛рж░ ржЖржмрж╢рзНржпржХ
    
    # рж╢рзБржзрзБржорж╛рждрзНрж░ push ржЗржнрзЗржирзНржЯрзЗ ржПржмржВ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржмрзНрж░рж╛ржЮрзНржЪржЧрзБрж▓рж┐рждрзЗржЗ рж░рж┐рж▓рж┐ржЬ рж╣ржмрзЗ
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Set up Java (for Android Build)
        # Android ржмрж┐рж▓рзНржбрзЗрж░ ржЬржирзНржп ржЖржзрзБржирж┐ржХ Java ржнрж╛рж░рзНрж╕ржи (17) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржи
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17' 
          
      - name: Install dependencies
        run: flutter pub get

      # --- Android Build (APK) ---
      # AAB ржмрж┐рж▓рзНржбрзЗрж░ ржзрж╛ржкржЯрж┐ (Build Android App Bundle) ржЖржкржирж╛рж░ ржЕржирзБрж░рзЛржз ржЕржирзБржпрж╛рзЯрзА ржмрж╛ржж ржжрзЗржУрзЯрж╛ рж╣рж▓рзЛред
        
      - name: Build Android APK (for direct distribution)
        run: flutter build apk --release --split-per-abi

      # --- iOS Build (IPA) ---
      - name: Build iOS IPA
        run: flutter build ipa --release 

      # рж░рж┐рж▓рж┐ржЬ рждрзИрж░рж┐ ржПржмржВ Artifacts ржЖржкрж▓рзЛржб
      - name: Push to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          # ржмрж┐рж▓рзНржЯ-ржЗржи GITHUB_TOKEN ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рж▓рзЛред ржПрж░ ржЬржирзНржп ржорзНржпрж╛ржирзБрзЯрж╛рж▓рж┐ рж╕рж┐ржХрзНрж░рзЗржЯ рждрзИрж░рж┐ ржХрж░рж╛рж░ ржжрж░ржХрж╛рж░ ржирзЗржЗред
          token: ${{ secrets.GITHUB_TOKEN }}
          # ржмрзНрж░рж╛ржЮрзНржЪ ржЕржирзБржпрж╛рзЯрзА ржЯрзНржпрж╛ржЧ рждрзИрж░рж┐: main ржПрж░ ржЬржирзНржп v1.0.X, develop ржПрж░ ржЬржирзНржп v1.0.X-develop
          tag_name: ${{ github.ref_name == 'main' && format('v1.0.{0}', github.run_number) || format('v1.0.{0}-{1}', github.run_number, github.ref_name) }}
          name: Release v1.0.${{ github.run_number }} (${{ github.ref_name }})
          body: Automated Release for branch `${{ github.ref_name }}`.
          draft: true # ржкрзНрж░ржержорзЗ Draft рж░рж┐рж▓рж┐ржЬ рж╣рж┐рж╕рзЗржмрзЗ рждрзИрж░рж┐ рж╣ржмрзЗ
          prerelease: ${{ github.ref_name != 'main' }} # Main ржЫрж╛ржбрж╝рж╛ ржЕржирзНржп рж╕ржм ржмрзНрж░рж╛ржЮрзНржЪ Prerelease
          files: |
            build/app/outputs/apk/release/*.apk  # рж╢рзБржзрзБржорж╛рждрзНрж░ APK ржлрж╛ржЗрж▓ рж░рж╛ржЦрж╛ рж╣рж▓рзЛ
            build/ios/ipa/*.ipa
