name: Flutter CI/CD

# Workflow‡¶ü‡¶ø ‡¶ï‡¶ñ‡¶® ‡¶ü‡ßç‡¶∞‡¶ø‡¶ó‡¶æ‡¶∞ ‡¶π‡¶¨‡ßá
on:
  pull_request:
    branches:
      - main
      - master
      - develop
  push:
    branches:
      - main
      - master
      - develop

jobs:
  # 1. CI Job: ‡¶ï‡ßã‡¶° ‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (Ubuntu ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá, ‡¶Ø‡¶æ ‡¶¶‡ßç‡¶∞‡ßÅ‡¶§ ‡¶ì ‡¶∏‡¶∏‡ßç‡¶§‡¶æ)
  test_and_analyze:
    name: üß™ Test & Analyze (CI)
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Flutter SDK ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™
      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Install dependencies
        run: flutter pub get

      - name: Check Code Formatting
        # ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶´‡¶∞‡¶Æ‡ßá‡¶ü‡¶ø‡¶Ç ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡ßü, ‡¶§‡¶¨‡ßá ‡¶´‡ßá‡¶á‡¶≤ ‡¶ï‡¶∞‡¶¨‡ßá
        run: dart format --set-exit-if-changed .

      - name: Analyze Project Source
        # Flutter-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø dart analyze ‡¶®‡¶Ø‡¶º, flutter analyze ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶≠‡¶æ‡¶≤‡ßã
        run: flutter analyze

      - name: Run Flutter Tests
        run: flutter test

  # 2. CD Job: ‡¶ü‡ßá‡¶∏‡ßç‡¶ü ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá ‡¶¨‡¶ø‡¶≤‡ßç‡¶° ‡¶è‡¶¨‡¶Ç ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø (iOS-‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø macos-latest ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®)
  build_and_release:
    name: üöÄ Build & Release (CD)
    needs: test_and_analyze # ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶ú‡¶¨ ‡¶∏‡¶´‡¶≤ ‡¶π‡¶≤‡ßá‡¶á ‡¶∞‡¶æ‡¶® ‡¶π‡¶¨‡ßá
    runs-on: macos-latest # iOS ‡¶¨‡¶ø‡¶≤‡ßç‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø macos ‡¶∞‡¶æ‡¶®‡¶æ‡¶∞ ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ï
    
    # ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ push ‡¶á‡¶≠‡ßá‡¶®‡ßç‡¶ü‡ßá ‡¶è‡¶¨‡¶Ç ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶¨‡ßç‡¶∞‡¶æ‡¶û‡ßç‡¶ö‡¶ó‡ßÅ‡¶≤‡¶ø‡¶§‡ßá‡¶á ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶π‡¶¨‡ßá
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Flutter SDK
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Set up Java (for Android Build)
        # Android ‡¶¨‡¶ø‡¶≤‡ßç‡¶°‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶ß‡ßÅ‡¶®‡¶ø‡¶ï Java ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶® (17) ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17' 
          
      - name: Install dependencies
        run: flutter pub get

      # --- Android Build (APK) ---
      # AAB ‡¶¨‡¶ø‡¶≤‡ßç‡¶°‡ßá‡¶∞ ‡¶ß‡¶æ‡¶™‡¶ü‡¶ø (Build Android App Bundle) ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶¨‡¶æ‡¶¶ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡¶≤‡ßã‡•§
        
      - name: Build Android APK (for direct distribution)
        run: flutter build apk --release --split-per-abi

      # --- iOS Build (IPA) ---
      - name: Build iOS IPA
        run: flutter build ipa --release 

      # ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç Artifacts ‡¶Ü‡¶™‡¶≤‡ßã‡¶°
      - name: Push to GitHub Releases
        uses: softprops/action-gh-release@v1
        with:
          # ‡¶¨‡¶ø‡¶≤‡ßç‡¶ü-‡¶á‡¶® GITHUB_TOKEN ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶≤‡ßã‡•§ ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á‡•§
          token: ${{ secrets.GITHUB_TOKEN }}
          # ‡¶¨‡ßç‡¶∞‡¶æ‡¶û‡ßç‡¶ö ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶§‡ßà‡¶∞‡¶ø: main ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø v1.0.X, develop ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø v1.0.X-develop
          tag_name: ${{ github.ref_name == 'main' && format('v1.0.{0}', github.run_number) || format('v1.0.{0}-{1}', github.run_number, github.ref_name) }}
          name: Release v1.0.${{ github.run_number }} (${{ github.ref_name }})
          body: Automated Release for branch `${{ github.ref_name }}`.
          draft: true # ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá Draft ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶¨‡ßá
          prerelease: ${{ github.ref_name != 'main' }} # Main ‡¶õ‡¶æ‡¶°‡¶º‡¶æ ‡¶Ö‡¶®‡ßç‡¶Ø ‡¶∏‡¶¨ ‡¶¨‡ßç‡¶∞‡¶æ‡¶û‡ßç‡¶ö Prerelease
          files: |
            build/app/outputs/apk/release/*.apk  # ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ APK ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∞‡¶æ‡¶ñ‡¶æ ‡¶π‡¶≤‡ßã
            build/ios/ipa/*.ipa
